<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
	<title>The Island</title>
    <script src="//cdn.jsdelivr.net/phaser/2.2.2/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
            background-image: url(assets/starrysky.png);
            background-size: cover;
            
        }
        p{
            color:white;
            font-family: arial;
            text-align:center;
        }
       
    </style>
</head>
<body>
    <p>banana Press F for Fullscreen.</p>
<script type="text/javascript">
/*******************
**Global Variables**
*******************/
var game = new Phaser.Game(480, 480, Phaser.AUTO,'', { preload: preload, create: create, update: update });
var SCALE = 16;
var gameMode = 0;
var timer;
var text;
var NARRATION1 = "Welcome to the middle of nowhere! Once upon a time, some shitty volcanoes erupted and created an island."
var narration1 = "";
var speechBubble;
var textCount = 0;
var narrationCount = 0;
var counter = 0;
var eruptBar;
var volcanoes = [];
var fsButton;
var islandMap;
var layer1;
var platforms;
var player;
var cursors;
var click = false;
var lavaFlows = [];
var lavaCount; //Used for preventing multiple eruptions at once
var lavaIndex = 0; //keep track of lava in array
var lavaSpawned = false; //register only one click at a time
var mapArray = createArray(30,30);
var debug;
var islandSize = 0;
var narrator;
LavaFlow = function (index, start, game){
    var x, y;
    
    this.index = index;
    this.game = game;
    this.last = 0;
    this.start = start;
    this.speed = 0;
    if (start == 1){x=224;y=224;
        if(mapArray[14][14] == 2){
            mapArray[14][14] = 3;
            volcanoes[0] = game.add.sprite(x, y, 'landVolcano');}}
    else if (start == 2){x=240;y=224;
        if(mapArray[15][14] == 2){
            mapArray[15][14] = 3;
            volcanoes[1] = game.add.sprite(x, y, 'landVolcano');}}
    else if (start == 3){x=224;y=240;
        if(mapArray[14][15] == 2){
            mapArray[14][15] = 3;
            volcanoes[2] = game.add.sprite(x, y, 'landVolcano');}}
    else if (start == 4){x=240;y=240;
        if(mapArray[15][15] == 2){
            mapArray[15][15] = 3;
            volcanoes[3] = game.add.sprite(x, y, 'landVolcano');}}
    mapArray[14][14] = 2;
    mapArray[15][14] = 2;
    mapArray[14][15] = 2;
    mapArray[15][15] = 2;
    this.alive = true;

    this.lava = game.add.sprite(x, y, 'lavaflow');
    this.lava.animations.add('flow', [0,1,2], 6);
    this.update = function(){
        this.lava.animations.play('flow');
    }
    this.checkLava = function(){
        //Move lava in random direction
        
        var x = this.lava.x;
        var y = this.lava.y;
        
        var dir;
        if (this.start == 1){ //Top Left
            dir = game.rnd.integerInRange(1,2);
            if (dir == 1){x -= SCALE;} //Move Left
            else if(dir == 2){y -= SCALE} //Move Up
        }else if (this.start == 2){ //Top Right
            dir = game.rnd.integerInRange(1,2);
            if (dir == 1){x += SCALE;} //Move Right
            else if(dir == 2){y -= SCALE} //Move Up
        }else if (this.start == 3){ //Bottom Left
            dir = game.rnd.integerInRange(1,2);
            if (dir == 1){x -= SCALE;} //Move Left
            else if(dir == 2){y += SCALE} //Move Down
        }else if (this.start == 4){ //Bottom Right
            dir = game.rnd.integerInRange(1,2);
            if (dir == 1){x += SCALE;} //Move Right
            else if(dir == 2){y += SCALE} //Move Down
        }
        
        var tween = this.game.add.tween(this.lava).to({x: x, y: y},500+this.speed, Phaser.Easing.Linear.None, true);
        tween.onComplete.add(this.move, this);
    }
    this.move = function(){
        //Move complete. Add logic to determine what tile is under lava
        var tileX = this.lava.x /16;
        var tileY = this.lava.y /16;
        var mnt = game.rnd.integerInRange(1,100);
        if (this.speed >= 300){this.lava.tint = 0x808080;}
        else if(this.speed >= 200){this.lava.tint = 0xA9A9A9;}
        else if (this.speed >= 100){this.lava.tint = 0xBEBEBE;}
        else if (this.speed >= 0){this.lava.tint = 0xF5F5F5;}
        
        if(mapArray[tileX][tileY] == 0){ //no ground
            
            game.add.sprite(this.lava.x,this.lava.y,'ground');
            mapArray[tileX][tileY] = 1
            islandSize +=1;
            this.destroy();
        
        } else if (mapArray[tileX][tileY] == 1){
            
            if(this.speed >= 400 && mnt <= 20){
                mapArray[tileX][tileY] = 4;
                
                game.add.sprite(this.lava.x,this.lava.y,'mountain');
                this.destroy();
            } else if (this.speed >= 300 && mnt <=10){
                mapArray[tileX][tileY] = 4;
                
                game.add.sprite(this.lava.x,this.lava.y,'mountain');
                this.destroy();
            } else if (this.speed >= 200 && mnt <=5){
                mapArray[tileX][tileY] = 4;
                
                game.add.sprite(this.lava.x,this.lava.y,'mountain');
                this.destroy();
            } else if (this.speed >= 100 && mnt <=2){
                mapArray[tileX][tileY] = 4;
                
                game.add.sprite(this.lava.x,this.lava.y,'mountain');
                this.destroy();
            }else {this.checkLava();this.speed+= game.rnd.integerInRange(50,150);}
            
            
        }else {this.checkLava();this.speed+= game.rnd.integerInRange(50,150);}
    }
    this.destroy = function(){
        lavaFlows.splice(this.index, 1);
        this.lava.destroy();
        lavaCount -= 1;
        if (lavaCount == 0){
            lavaSpawned = false;
        }
    }

};


    
    


function preload() {
    
    game.load.image('sky', 'assets/sky.png');
    game.load.image('ground', 'assets/grass1.png');
    game.load.image('star', 'assets/star.png');
    game.load.spritesheet('dude', 'assets/dude.png', 32, 48);
    game.load.image('tiles','assets/island.png');
    game.load.image('debug','assets/debug.png');
    game.load.image('seaVolcano','assets/volcano.png');
    game.load.image('landVolcano','assets/volcanograss.png');
    game.load.spritesheet('lavaflow','assets/lavaflow.png',16,16);
    game.load.image('eruptbar','assets/eruptBar.png');
    game.load.image('fire','assets/fire.png');
    game.load.image('narrator','assets/oldman.png');
    game.load.image('speech','assets/speechbubble.png');
    game.load.image('mountain','assets/mountain.png');
}


    
function create() {
    
   
    /******************8
   Full Screen Options
   ********************/
    //options for fullscreen
    // Stretch to fill
    //game.scale.fullScreenScaleMode = Phaser.ScaleManager.EXACT_FIT;

    // Keep original size
    // game.scale.fullScreenScaleMode = Phaser.ScaleManager.NO_SCALE;

    // Maintain aspect ratio
     game.scale.fullScreenScaleMode = Phaser.ScaleManager.SHOW_ALL;
    
    //fullscreen hotkey
    fullscreenHotkey = game.input.keyboard.addKey(Phaser.Keyboard.F);
    fullscreenHotkey.onDown.add(gofull, this);
    
    /******************8
   Setting up the TileMap
   ********************/
    
    //  Create some map data dynamically
    //  Map size is 30x30 tiles
    var data = '';
    
    for (var y = 0; y < 30; y++)
    {
        for (var x = 0; x < 30; x++)
        {
            data += "0";
            mapArray[x][y] = "0";
            if (x < 29)
            {
                data += ',';
            }
        }

        if (y < 29)
        {
            data += "\n";
        }
    }
    
    //  Add data to the cache
    game.cache.addTilemap('dynamicMap', null, data, Phaser.Tilemap.CSV);
    
    //  Create our map (the 16x16 is the tile size)
    map = game.add.tilemap('dynamicMap', SCALE, SCALE);
    
    //  'tiles' = cache image key, 16x16 = tile size
    map.addTilesetImage('tiles', 'tiles', SCALE, SCALE);
    
    //  0 is important
    layer = map.createLayer(0);
    
    //resize the world
    layer.resizeWorld();
  
    /******************8
   Physics
   ********************/
    //  We're going to be using physics, so enable the Arcade Physics system
    game.physics.startSystem(Phaser.Physics.ARCADE);

    
    
    timer = game.time.create(false);
    timer.loop(50, updateText, this);
    //text = game.add.text(250, 16, '', { fill: '#ffffff' });
    
    //Set Volcano Tiles in Array
    mapArray[14][14] = 2;
    mapArray[15][14] = 2;
    mapArray[14][15] = 2;
    mapArray[15][15] = 2;
    intro();
}
function intro(){
    speechBubble = game.add.sprite(5,50,'speech');
    speechBubble.scale.setTo(.5,.25);
    narrator = game.add.sprite(360,280,'narrator');
    narrator.scale.setTo(.25,.25);
    text = game.add.text(40,80,"",{ font: "25px Arial", fill: '#000000', wordWrap: true, wordWrapWidth: 400 });
    timer.start();
}
function updateText(signal){
    if(!(narration1 == NARRATION1)){narration1 = narration1 + NARRATION1.substr(textCount,1);textCount += 1;}
    if(narration1 == NARRATION1){
        //Done with text
        if (signal == 1 && narrationCount == 0){
            NARRATION1 = "Well... Do it, fucker!";
            narration1 = "";
            textCount = 0;
            narrationCount = 1;
        }else if (narrationCount == 1){narrationCount = 2;}
        if(signal == 1 && narrationCount == 2){
            timer.destroy();
            narrator.destroy();
            speechBubble.destroy();
            text.destroy();
            islandCreation();
        }
    }else if(signal == 1){
        narration1 = NARRATION1;
        //timer.destroy();
    }
    
    text.setText(narration1);
    
}
function pause(){
    //slight delay to allow game to load after intro
    gameMode = 1;
    volcanoes[0] = game.add.sprite(224,224,'seaVolcano');
    volcanoes[1] = game.add.sprite(240,224,'seaVolcano');
    volcanoes[2] = game.add.sprite(224,240,'seaVolcano');
    volcanoes[3] = game.add.sprite(240,240,'seaVolcano');
    eruptBar = game.add.sprite(0,460,'eruptbar');
    fire = game.add.sprite(3,450,'fire');
    timer.destroy();
}
function islandCreation(){
    timer = game.time.create(true);
    timer.loop(500, pause, this);
    timer.start();
    
}

function gofull() {

    game.scale.startFullScreen();

}

function update() {
    if (gameMode == 1){moveFire();}
    
    
    if (game.input.activePointer.isUp && click){
        click = false;
        if(gameMode == 0){
            updateText(1);
        }
        if(gameMode ==1){erupt();}
    }
    if (game.input.activePointer.isDown){
        click = true;
    }
    lavaFlows.forEach(function(element){
        element.update();
    })

    
    
    
    this.game.scale.pageAlignHorizontally = true;this.game.scale.pageAlignVertically = true;this.game.scale.refresh();
    //changeMap(15,15,"5");
    //drawMap();
    
    
}
    
/*********************************************************
borrowed code from stackoverflow for creating n-dimension array
**********************************************************/
function createArray(length) {
    var arr = new Array(length || 0),
        i = length;

    if (arguments.length > 1) {
        var args = Array.prototype.slice.call(arguments, 1);
        while(i--) arr[length-1 - i] = createArray.apply(this, args);
    }

    return arr;
}
/*********************************************************
drawing the map from an array to the data
**********************************************************/
function drawMap(){
    var data;
    for (var y = 0; y < 30; y++)
    {
        for (var x = 0; x < 30; x++)
        {
            data += mapArray[x][y];
            if (x < 29)
            {
                data += ',';
            }
        }

        if (y < 29)
        {
            data += "\n";
        }
    }
    
    
}
function erupt(){
    var picked = [];
    if (!lavaSpawned){
    if(fire.x >= 3 && fire.x <= 130){
        //alert(picked[0]);
        lavaCount = 1;
        lavaFlows[lavaIndex] = new LavaFlow(lavaIndex,picked[0]=lavaStart(picked),game) ;
        lavaFlows[lavaIndex].checkLava();
        lavaIndex +=1;
    }else if(fire.x >= 131 && fire.x <= 320){
        lavaCount = 2;
        lavaFlows[lavaIndex] = new LavaFlow(lavaIndex,picked[0]=lavaStart(picked),game) ;
        lavaFlows[lavaIndex].checkLava();
        lavaIndex +=1;
        lavaFlows[lavaIndex] = new LavaFlow(lavaIndex,picked[1]=lavaStart(picked),game) ;
        lavaFlows[lavaIndex].checkLava();
        lavaIndex +=1;
    }else if(fire.x >= 321){
        lavaCount = 3;
        lavaFlows[lavaIndex] = new LavaFlow(lavaIndex,picked[0]=lavaStart(picked),game) ;
        lavaFlows[lavaIndex].checkLava();
        lavaIndex +=1;
        lavaFlows[lavaIndex] = new LavaFlow(lavaIndex,picked[1]=lavaStart(picked),game) ;
        lavaFlows[lavaIndex].checkLava();
        lavaIndex +=1;
        lavaFlows[lavaIndex] = new LavaFlow(lavaIndex,picked[2]=lavaStart(picked),game) ;
        lavaFlows[lavaIndex].checkLava();
        lavaIndex +=1;
    }
        
    
    }
    lavaSpawned = true;
}
function moveFire(){
    if (fire.x == 448)
        {
            game.add.tween(fire).to({x: 3}, 1000 , Phaser.Easing.Out, true);

        }
    else if (fire.x == 3)
        {
            game.add.tween(fire).to({x: 448}, 1000 , Phaser.Easing.Out, true);

        }
}
function lavaStart(lavas){
    //Set unique lava start location
    var picked;
    var start;
    do{
        picked = false;
        start = game.rnd.integerInRange(1, 4);
        lavas.forEach(function(element){
            if(element == start){picked = true;}
        }) 
    } while(picked);
    
    return start;
}

</script>

</body>
</html>